# 實作任務：可插拔事實來源適配器

## 總覽
可插拔事實來源適配器架構的實作檢查清單。遵循規格驅動開發流程：提案 → 實作 → 驗證 → 測試 → 歸檔。

## 階段 1：基礎（適配器介面與註冊表）

### 任務 1.1：建立 FactSourceAdapter 介面
- [ ] 建立 `src/types/adapters.ts`，包含 TypeScript 介面
- [ ] 定義 `FactSourceAdapter` 介面與必要方法
- [ ] 定義 `VerificationResult` 介面與所有欄位
- [ ] 定義 `VerificationContext` 介面用於可選上下文
- [ ] 定義 `AggregatedResult` 介面用於組合結果
- [ ] 新增 JSDoc 註解解釋每個介面
- [ ] 驗證 TypeScript 編譯
- [ ] 撰寫型別測試以確保介面安全

### 任務 1.2：實作 AdapterRegistry 類別
- [ ] 建立 `src/adapters/registry.ts` 檔案
- [ ] 實作註冊表以儲存適配器實例
- [ ] 新增 `register(adapter: FactSourceAdapter)` 方法
- [ ] 新增 `getAdapter(id: string)` 方法
- [ ] 新增 `listAdapters()` 方法
- [ ] 新增 `removeAdapter(id: string)` 方法
- [ ] 在註冊時實作適配器驗證
- [ ] 驗證實作每個類別 <100 行

### 任務 1.3：建立適配器基礎類別
- [ ] 建立 `src/adapters/base.ts` 檔案
- [ ] 實作包含共用邏輯的抽象基礎類別
- [ ] 新增預設 `isAvailable()` 實作
- [ ] 新增錯誤處理工具
- [ ] 新增結果格式化輔助函式
- [ ] 撰寫基礎類別的單元測試
- [ ] 確保開發者可以輕鬆擴展

## 階段 2：內建驗證器

### 任務 2.1：實作矛盾偵測器（ContradictionDetector）
- [ ] 建立 `src/validators/contradiction-detector.ts`
- [ ] 實作基於模式的矛盾偵測
- [ ] 新增常見矛盾模式的支援
- [ ] 基於模式強度實作信心評分
- [ ] 新增可配置模式的支援
- [ ] 確保典型聲明的回應時間 <200ms
- [ ] 處理邊界情況（null、空白、超大聲明）
- [ ] 撰寫全面的單元測試
- [ ] 使用 100+ 矛盾聲明對進行測試

### 任務 2.2：實作模式驗證器（PatternValidator）
- [ ] 建立 `src/validators/pattern-validator.ts`
- [ ] 實作模式匹配邏輯
- [ ] 新增聲明變體的模糊匹配
- [ ] 建立預設模式庫（10+ 模式）
- [ ] 實作模式權重系統
- [ ] 新增模式的正則表達式支援
- [ ] 確保回應時間 <200ms
- [ ] 撰寫模式匹配的單元測試
- [ ] 測試模糊匹配準確度

### 任務 2.3：實作信心分數聚合器（ConfidenceScorer）
- [ ] 建立 `src/validators/confidence-scorer.ts`
- [ ] 實作加權聚合邏輯
- [ ] 新增多數決邏輯
- [ ] 實作判定計算
- [ ] 新增可配置的聚合策略
- [ ] 處理缺失/不可用的適配器
- [ ] 產生清晰的推理字串
- [ ] 確保回應時間 <100ms
- [ ] 撰寫所有聚合策略的單元測試

## 階段 3：協調

### 任務 3.1：實作適配器協調器（AdapterOrchestrator）
- [ ] 建立 `src/orchestrator/orchestrator.ts`
- [ ] 實作並行驗證邏輯
- [ ] 新增逾時強制執行
- [ ] 實作並行執行限制
- [ ] 在適配器之間新增錯誤隔離
- [ ] 實作斷路器模式
- [ ] 新增詳細的除錯日誌
- [ ] 撰寫協調的單元測試
- [ ] 測試 20+ 適配器並行

### 任務 3.2：實作結果聚合
- [ ] 建立 `src/orchestrator/aggregator.ts`
- [ ] 實作結果收集邏輯
- [ ] 實作分數聚合
- [ ] 按信心度新增結果排序
- [ ] 確保保留所有來源結果
- [ ] 格式化組合推理
- [ ] 撰寫單元測試
- [ ] 測試混合結果（已驗證/矛盾/不確定）

### 任務 3.3：實作快取層
- [ ] 建立 `src/orchestrator/cache.ts`
- [ ] 實作記憶體內快取
- [ ] 新增 TTL 支援（預設 1 小時）
- [ ] 新增快取大小限制
- [ ] 實作快取統計
- [ ] 新增快取失效
- [ ] 撰寫單元測試
- [ ] 測試快取效能

## 階段 4：核心整合

### 任務 4.1：更新 FactGate 主類別
- [ ] 修改 `src/factgate.ts`（或主類別）
- [ ] 新增適配器配置參數
- [ ] 初始化 AdapterOrchestrator
- [ ] 更新 verify() 方法以使用協調器
- [ ] 維持向後相容性
- [ ] 新增配置驗證
- [ ] 撰寫整合測試
- [ ] 記錄使用範例

### 任務 4.2：實作配置系統
- [ ] 建立 `src/config/adapter-config.ts`
- [ ] 定義配置介面
- [ ] 實作驗證
- [ ] 新增預設配置
- [ ] 支援環境變數覆蓋
- [ ] 新增配置檔案支援
- [ ] 撰寫所有配置場景的測試

### 任務 4.3：新增適配器工具
- [ ] 建立 `src/adapters/utils.ts`
- [ ] 實作逾時包裝器
- [ ] 實作錯誤處理包裝器
- [ ] 實作結果格式化器
- [ ] 新增日誌工具
- [ ] 撰寫單元測試
- [ ] 為自訂適配器作者撰寫文件

## 階段 5：測試

### 任務 5.1：撰寫單元測試
- [ ] 測試適配器介面合規性
- [ ] 測試註冊表操作（新增/移除/列出）
- [ ] 個別測試內建驗證器
- [ ] 測試協調器並行執行
- [ ] 測試逾時強制執行
- [ ] 測試錯誤處理
- [ ] 測試結果聚合
- [ ] 達成 >95% 程式碼覆蓋率

### 任務 5.2：撰寫整合測試
- [ ] 測試多個適配器協同運作
- [ ] 測試適配器失敗場景
- [ ] 測試逾時場景
- [ ] 測試結果聚合準確性
- [ ] 測試向後相容性
- [ ] 測試配置載入
- [ ] 為自訂適配器建立測試套件
- [ ] 記錄測試模式

### 任務 5.3：撰寫效能測試
- [ ] 驗證端對端回應時間 <500ms
- [ ] 測試 1000+ 聲明（快取有效性）
- [ ] 測試並行驗證請求
- [ ] 測量記憶體使用量
- [ ] 測試 50+ 適配器
- [ ] 對每個內建驗證器進行基準測試
- [ ] 建立效能基準
- [ ] 記錄效能特性

### 任務 5.4：撰寫自訂適配器範例
- [ ] 建立 `examples/wikipedia-adapter.ts`
- [ ] 實作功能完整的 Wikipedia 適配器
- [ ] 記錄適配器開發流程
- [ ] 包含錯誤處理範例
- [ ] 包含快取範例
- [ ] 新增使用範例
- [ ] 為自訂適配器撰寫 README
- [ ] 作為社群的參考

## 階段 6：文件與潤飾

### 任務 6.1：撰寫 API 文件
- [ ] 記錄 FactSourceAdapter 介面
- [ ] 記錄 VerificationResult 結構
- [ ] 記錄配置選項
- [ ] 記錄 AdapterRegistry 使用方法
- [ ] 記錄 AdapterOrchestrator 使用方法
- [ ] 新增 TypeDoc 註解到原始碼
- [ ] 產生 HTML 文件
- [ ] 建立快速入門指南

### 任務 6.2：撰寫開發者指南
- [ ] 建立「建立自訂適配器」指南
- [ ] 記錄適配器開發模式
- [ ] 提供樣板適配器範本
- [ ] 展示範例適配器（Wikipedia 等）
- [ ] 記錄測試自訂適配器
- [ ] 新增疑難排解章節
- [ ] 建立效能最佳化指南
- [ ] 記錄適配器可靠度追蹤

### 任務 6.3：撰寫使用者文件
- [ ] 記錄配置語法
- [ ] 建立配置範例
- [ ] 記錄聚合策略
- [ ] 記錄結果格式
- [ ] 建立疑難排解指南
- [ ] 記錄 MCP 整合
- [ ] 為現有使用者新增遷移指南
- [ ] 建立常見問題集

### 任務 6.4：新增日誌與除錯
- [ ] 實作結構化日誌
- [ ] 新增除錯模式
- [ ] 記錄適配器啟動/關閉
- [ ] 記錄驗證流程
- [ ] 記錄適配器失敗
- [ ] 新增追蹤層級日誌
- [ ] 記錄日誌配置
- [ ] 建立除錯指南

## 階段 7：驗證與品質保證

### 任務 7.1：程式碼審查
- [ ] 根據規格需求進行自我審查
- [ ] 驗證所有場景已測試
- [ ] 檢查規格合規性
- [ ] 驗證設計決策已記錄
- [ ] 檢查程式碼品質標準
- [ ] 確保內建驗證器無外部依賴

### 任務 7.2：規格合規性
- [ ] 執行 `openspec validate add-pluggable-source-adapters --strict`
- [ ] 驗證所有 ADDED 需求已實作
- [ ] 驗證所有場景已測試
- [ ] 驗證所有規格已記錄
- [ ] 修正任何驗證失敗

### 任務 7.3：安全審查
- [ ] 審查輸入驗證
- [ ] 檢查注入漏洞
- [ ] 審查錯誤訊息是否洩漏資訊
- [ ] 驗證適配器隔離
- [ ] 檢查資源耗盡漏洞
- [ ] 記錄安全考量
- [ ] 建立安全最佳實踐指南

### 任務 7.4：效能驗證
- [ ] 驗證端對端回應 <500ms
- [ ] 驗證每個內建驗證器 <200ms
- [ ] 驗證信心分數聚合器 <100ms
- [ ] 使用實際負載測試
- [ ] 記錄效能特性
- [ ] 建立效能調校指南

## 階段 8：發布準備

### 任務 8.1：建立 CHANGELOG 條目
- [ ] 描述新的適配器模式
- [ ] 列出新增的內建驗證器
- [ ] 記錄破壞性變更（如果有）
- [ ] 連結到文件
- [ ] 註記版本號
- [ ] 感謝貢獻者

### 任務 8.2：準備遷移指南
- [ ] 記錄升級流程
- [ ] 展示向後相容性
- [ ] 提供配置範例
- [ ] 建立前後比較
- [ ] 列出常見模式

### 任務 8.3：標記發布
- [ ] 建立發布的 git 標籤
- [ ] 推送標籤到倉庫
- [ ] 產生發布說明
- [ ] 發布到 npm（如果適用）

### 任務 8.4：歸檔變更
- [ ] 將 `changes/add-pluggable-source-adapters/` 移至 `changes/archive/YYYY-MM-DD-add-pluggable-source-adapters/`
- [ ] 使用新功能更新 `specs/`
- [ ] 驗證 git 歷史已保留
- [ ] 為歸檔提交建立 PR

## 驗證檢查清單

標記為完成前，請驗證：

- [ ] 規格中的所有 ADDED 需求已實作
- [ ] 規格中的所有場景已測試並通過
- [ ] 程式碼覆蓋率 >95%（由測試套件測量）
- [ ] 回應時間 <500ms 已驗證
- [ ] 內建驗證器可離線運作
- [ ] 核心驗證器無外部依賴
- [ ] 維持向後相容性
- [ ] 所有文件完成
- [ ] 效能基準已記錄
- [ ] 安全審查完成
- [ ] `openspec validate --strict` 通過
- [ ] 所有測試通過
- [ ] 準備部署

## 成功指標

完成時，以下應該為真：

1. ✅ 開發者可以在 <50 行內實作自訂適配器
2. ✅ 內建驗證器回應時間 <200ms
3. ✅ 多個來源可以串聯而不降級
4. ✅ 系統維持 >95% 測試覆蓋率
5. ✅ 文件可讓人獨立建立自訂適配器
6. ✅ 與現有驗證呼叫向後相容
7. ✅ 疑難排解的錯誤訊息清晰
8. ✅ 效能基準已建立並記錄