# 設計文件：可插拔事實來源適配器

## 架構總覽

```
┌─────────────────────────────────────────────────────────┐
│                   FactGate 核心                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │              驗證引擎                             │   │
│  │         (協調所有事實來源)                        │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                  │
│         ┌──────────────┼──────────────┐                   │
│         ▼              ▼              ▼                   │
│  ┌─────────────┐ ┌──────────────┐ ┌──────────────┐     │
│  │  內建：     │ │  內建：      │ │   自訂來源   │     │
│  │ 矛盾偵測器  │ │  模式驗證器  │ │  (使用者實作)│     │
│  └─────────────┘ └──────────────┘ └──────────────┘     │
│         │              │              │                   │
│         └──────────────┼──────────────┘                   │
│                        ▼                                  │
│           ┌─────────────────────────┐                   │
│           │  信心分數聚合器          │                   │
│           │  (內建聚合器)           │                   │
│           └─────────────────────────┘                   │
│                        │                                  │
│                        ▼                                  │
│           ┌─────────────────────────┐                   │
│           │  結構化結果              │                   │
│           │  (含推理過程)           │                   │
│           └─────────────────────────┘                   │
└─────────────────────────────────────────────────────────┘
```

## 核心概念

### 1. 來源適配器介面
所有事實來源實作一致的介面：

```typescript
interface FactSourceAdapter {
  name: string;
  description: string;

  verify(
    claim: string,
    context?: VerificationContext
  ): Promise<VerificationResult>;

  isAvailable(): Promise<boolean>;
}
```

### 2. 驗證結果結構
適配器回傳標準化的結果：

```typescript
interface VerificationResult {
  sourceId: string;
  verdict: 'verified' | 'contradicted' | 'uncertain';
  confidence: number;        // 0-1 區間
  reasoning: string;
  details?: Record<string, unknown>;
  timestamp: Date;
}
```

### 3. 聚合驗證結果
最終輸出給 MCP 客戶端：

```typescript
interface AggregatedResult {
  claim: string;
  overall: 'verified' | 'contradicted' | 'uncertain';
  confidence: number;        // 0-1 區間
  sources: VerificationResult[];
  combinedReasoning: string;
  processingTime: number;
}
```

## 實作策略

### 功能 1：來源適配器介面與註冊表
**目的：** 定義所有適配器必須遵循的契約，並管理其生命週期

**關鍵設計決策：**
1. 非同步優先設計，同時支援同步和非同步來源
2. 可選的 `context` 參數，為未來擴展性預留空間
3. `isAvailable()` 方法允許來源故障時優雅降級
4. 註冊表模式用於發現和管理適配器

### 功能 2：內建矛盾偵測器
**目的：** 識別邏輯矛盾的聲明，無需外部依賴

**方法：**
1. 基於模式的矛盾偵測（例如："是 X" vs "不是 X"）
2. 常見矛盾的簡單語義分析
3. 基於矛盾強度的可插拔信心評分
4. 保證 <500ms 回應時間

### 功能 3：內建模式驗證器
**目的：** 根據已知的錯誤模式驗證聲明

**方法：**
1. 維護可配置的模式庫
2. 比對聲明與已知的問題模式
3. 根據模式強度回傳信心分數
4. 無外部依賴

### 功能 4：內建信心分數聚合器
**目的：** 將多個來源的結果聚合為統一的信心分數

**方法：**
1. 來源結果的加權聚合
2. 可配置的權重策略（等權重、可靠度加權、自訂）
3. 優雅處理缺失的來源
4. 為最終信心分數提供清晰的推理

### 功能 5：適配器註冊表與協調
**目的：** 管理適配器並協調跨適配器的驗證

**方法：**
1. 維護適配器元資料的中央註冊表
2. 跨所有適配器的並行驗證
3. 慢速來源的逾時處理
4. 錯誤隔離（單一來源失敗不影響其他來源）
5. 重複聲明的快取策略

## 資料流

```
使用者呼叫: verify("聲明文字")
  │
  ├─> 載入已註冊的適配器
  │
  ├─> 跨所有適配器並行化驗證
  │   ├─> 矛盾偵測器.verify()
  │   ├─> 模式驗證器.verify()
  │   ├─> 信心分數聚合器.verify()
  │   └─> 自訂適配器.verify()（如果有配置）
  │
  ├─> 收集所有結果並處理逾時
  │
  ├─> 聚合結果為最終信心分數
  │
  └─> 回傳 AggregatedResult 給呼叫者
```

## 配置範例

```typescript
const factGate = new FactGate({
  adapters: [
    {
      adapter: new ContradictionDetector(),
      weight: 0.3,
      timeout: 200
    },
    {
      adapter: new PatternValidator(),
      weight: 0.2,
      timeout: 200
    },
    {
      adapter: new ConfidenceScorer(),
      weight: 0.2,
      timeout: 300
    }
  ],
  aggregationStrategy: 'weighted-average',
  maxParallelSources: 10,
  defaultTimeout: 500
});
```

## 擴展點

### 給建立自訂適配器的使用者：
1. 實作 `FactSourceAdapter` 介面
2. 回傳包含判定和信心分數的 `VerificationResult`
3. 可選地實作快取以提升效能
4. 使用 `addAdapter()` 向 FactGate 註冊

### 自訂適配器範例：
```typescript
class WikipediaAdapter implements FactSourceAdapter {
  name = 'wikipedia';

  async verify(claim: string): Promise<VerificationResult> {
    // 查詢 Wikipedia API
    // 解析結果
    // 回傳結構化結果
  }

  async isAvailable(): Promise<boolean> {
    // 檢查 API 連線
  }
}
```

## 錯誤處理策略

1. **適配器失敗：** 隔離失敗，繼續使用其他來源
2. **逾時：** 從已完成的來源回傳部分結果
3. **無效聲明：** 回傳 'uncertain' 判定與適當的推理
4. **配置錯誤：** 在初始化期間快速失敗

## 效能考量

1. **並行化：** 所有適配器並行執行
2. **逾時：** 內建驗證器必須在 <200ms 內完成
3. **快取：** 快取最近的結果以減少重複驗證
4. **斷路器：** 重複失敗後停用不可用的來源
5. **資源限制：** 限制並行適配器執行數量

## 安全考量

1. **輸入驗證：** 在處理前淨化聲明
2. **適配器信任：** 僅載入受信任的適配器（白名單方法）
3. **速率限制：** 防止濫用昂貴的適配器
4. **敏感資料：** 生產環境中不記錄完整聲明
5. **隔離：** 適配器無法修改共享狀態

## 測試策略

1. **單元測試：** 每個適配器獨立測試
2. **整合測試：** 多個適配器協同運作
3. **效能測試：** 驗證 <500ms 回應時間
4. **錯誤場景：** 測試逾時、失敗、降級模式
5. **模擬適配器：** 建立用於測試協調邏輯的存根

## 依賴項與限制

**內建驗證器無需外部依賴**
- 純 JavaScript/TypeScript 實作
- 僅需 Node.js 20.19.0+ 標準函式庫

**MCP 協議相容性：**
- 適配器結果必須可序列化為 JSON 以供 MCP 傳輸
- 無循環參照或不可序列化物件

## 遷移路徑

**對現有程式碼：**
- 當前驗證邏輯成為「預設適配器」
- 現有 verify() 方法簽章不變
- 新適配器配置為可選（向後相容）
- 棄用時程：無（完全向後相容）

## 未來擴展

1. **適配器市集：** 發現社群建立的適配器
2. **可靠度指標：** 追蹤適配器隨時間的準確性
3. **學習：** 根據回饋改進信心評分
4. **串聯策略：** 自訂組合結果的邏輯
5. **非同步快取：** 跨重啟的持久化快取